// ===========================================================
// ðŸ“¦ APP BUILD.GRADLE â€” BulkSMS
// ===========================================================

apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"

apply plugin: "kotlin-kapt"

// Expo Autolinking is handled in settings.gradle

// Helper to determine Hermes state safely
def isHermesEnabled = project.findProperty("hermesEnabled")?.toBoolean() ?: true

// Load keystore properties for release signing
def keystorePropertiesFile = rootProject.file("keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    namespace = "com.bulksms.smsmanager"
    compileSdkVersion 34
    
    ndkVersion "26.1.10909125"

    signingConfigs {
        release {
            if (keystorePropertiesFile.exists()) {
                storeFile file(keystoreProperties['storeFile'])
                storePassword keystoreProperties['storePassword']
                keyAlias keystoreProperties['keyAlias']
                keyPassword keystoreProperties['keyPassword']
            }
        }
    }

    defaultConfig {
        applicationId "com.bulksms.smsmanager"
        minSdkVersion 24
        targetSdkVersion 34
        versionCode 2
        versionName "1.1.1"
        resValue "string", "app_name", "BulkSMS"
        multiDexEnabled true

        // Expose Hermes state to Kotlin code
        buildConfigField "boolean", "IS_HERMES_ENABLED", isHermesEnabled.toString()

        ndk {
            abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
        }
    }

    // Define a variable to check if we are building for release
    def isReleaseBuild = gradle.startParameter.taskNames.any { it.contains("Release") }

    splits {
        abi {
            // âš¡ DISABLE splits entirely to ensure all native libraries are included
            enable false
            reset()
            include "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
            universalApk true
        }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
            applicationIdSuffix ".debug"
            resValue "string", "app_name", "BulkSMS Debug"
            minifyEnabled false
        }
        release {
            signingConfig signingConfigs.release
            shrinkResources false
            minifyEnabled false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
        coreLibraryDesugaringEnabled true
    }

    kotlinOptions {
        jvmTarget = "17"
    }

    sourceSets {
        main {
            assets.srcDirs = ['src/main/assets']
        }
    }

    packaging {
        jniLibs {
            pickFirsts += [
                "**/libjsi.so",
                "**/libc++_shared.so",
                "**/libreactnative.so",
                "**/libfbjni.so",
                "**/libreact_render*.so",
                "**/libreactnativejni.so",
                // âš¡ ADD THESE for Hermes support:
                "**/libhermes.so",
                "**/libhermes_executor.so",
                // âš¡ ADD op-sqlite native library:
                "**/libop-sqlite.so",
                // âš¡ ADD other common React Native native libraries:
                "**/libreact-native-reanimated.so",
                "**/libreact-native-gesture-handler.so",
                "**/libreact-native-svg.so",
                "**/libnotifee.so",
                "**/libreact-native-blob-util.so",
                "**/libpenguin.so"
            ]
        }
        resources {
            // âš¡ Exclude duplicate metadata files from multiple dependencies
            // These exclusions prevent build failures when dependencies include
            // duplicate LICENSE, NOTICE, or Kotlin module files.
            // Common in React Native apps with androidx + kotlin dependencies.
            excludes += [
                "META-INF/LICENSE*",
                "META-INF/NOTICE*",
                "META-INF/*.kotlin_module"
            ]
        }
    }

    buildFeatures {
        buildConfig true
    }

    lintOptions {
        checkReleaseBuilds false
        abortOnError false
    }

}

// âš¡ CRITICAL FIX: Copy op-sqlite native libraries to ensure they're packaged in release APK


dependencies {
    // Manual Expo Module Linking
    // Manual Expo Module Linking - Partial Restore
    implementation project(':expo-modules-core')
    // implementation project(':expo-application')
    // implementation project(':expo-asset')
    // implementation project(':expo-constants')
    // implementation project(':expo-file-system')
    // implementation project(':expo-font')
    // implementation project(':expo-haptics')
    // implementation project(':expo-keep-awake')
    // implementation project(':expo-linear-gradient')
    implementation("com.facebook.react:react-android:0.76.9")
    
    // Autolinking handles AsyncStorage and others automatically
    
    // Hermes engine - required for React Native 0.76+
    if (isHermesEnabled) {
        implementation("com.facebook.react:hermes-android:0.76.9")
    } else {
        implementation("org.webkit:android-jsc:+")
    }



    implementation("androidx.core:core-ktx:1.13.1")
    implementation("androidx.appcompat:appcompat:1.7.0")
    implementation("com.google.android.material:material:1.12.0")
    implementation("androidx.multidex:multidex:2.0.1")
    implementation("androidx.work:work-runtime-ktx:2.9.0")
    coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:2.0.4")
    
    // Apache PDFBox for PDF parsing (M-Pesa statement extraction)
    // Using Android-compatible version
    implementation("com.tom-roush:pdfbox-android:2.0.27.0")

    def room_version = "2.6.1"

    implementation "androidx.room:room-runtime:$room_version"
    implementation "androidx.room:room-ktx:$room_version"
    kapt "androidx.room:room-compiler:$room_version"
    
    // Lifecycle components
    implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.6.2"
    
    implementation 'org.nanohttpd:nanohttpd:2.3.1'
    implementation 'com.google.code.gson:gson:2.10.1'
}

apply from: new File(["node", "--print", "require.resolve('@react-native-community/cli-platform-android/package.json')"].execute(null, rootDir).text.trim(), "../native_modules.gradle"); applyNativeModulesAppBuildGradle(project)